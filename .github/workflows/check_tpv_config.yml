name: Check tool destinations and job configuration

on:
  pull_request:
    branches: [ master ]
    paths:
      - templates/galaxy/config/galaxy_job_conf.yml.j2
      - files/galaxy/dynamic_job_rules/production/total_perspective_vortex/*

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.11

    - name: Install dependencies
      env:
        TPV_VERSION: '3.1.3'
      run: |
        python -m pip install --upgrade pip
        pip install \
          total-perspective-vortex==$TPV_VERSION \
          'pydantic<2.12' \
          pyyaml \
          galaxy-app

    - name: Check TPV files and job conf
      env:
        SETTING: github
      shell: python
      run: |
        import re
        import subprocess
        import os
        import shutil

        # ------------------------------------------------------------------
        # Setup working directories
        # ------------------------------------------------------------------

        working_dir = '.github/workflows/check_tpv_config'
        hosts_file = os.path.join(working_dir, 'hosts')
        playbook_file = os.path.join(working_dir, 'template_playbook.yml')
        files_dir = os.path.join(working_dir, 'files')
        templates_dir = os.path.join(working_dir, 'templates')

        os.mkdir(files_dir)
        os.mkdir(templates_dir)

        # ------------------------------------------------------------------
        # Collect TPV and job config files
        # ------------------------------------------------------------------

        tpv_dir = 'files/galaxy/dynamic_job_rules/production/total_perspective_vortex'
        tpv_config_files = [os.path.join(tpv_dir, f) for f in os.listdir(tpv_dir)]
        job_conf_template = 'templates/galaxy/config/galaxy_job_conf.yml.j2'
        tpv_files = []

        replace_patterns = [
            r'\{\{\s?vault_\w+\s?\}\}',
            r'\{\{\s?hostname\s?\}\}',
        ]

        with open('.vault_pass.txt', 'w') as password_file:
            password_file.write('FalsePassword')

        # ------------------------------------------------------------------
        # Helper functions
        # ------------------------------------------------------------------

        def template_file(fname):
            output_fname = fname.replace(templates_dir, files_dir).replace('.j2', '')
            extra_vars = (
                f"src={fname.replace(templates_dir + '/', '')} "
                f"dest={os.path.realpath(output_fname)}"
            )
            ansible_command = (
                f"ansible-playbook -i {hosts_file} {playbook_file} "
                f"--extra-vars '{extra_vars}'"
            )
            subprocess.check_call(ansible_command, shell=True)
            return output_fname

        def sanitize_text(fname):
            with open(fname) as handle:
                text = handle.read()
            for rp in replace_patterns:
                text = re.sub(rp, 'text_replaced', text)
            with open(fname, 'w') as handle:
                handle.write(text)

        # ------------------------------------------------------------------
        # Prepare files for linting
        # ------------------------------------------------------------------

        for t in tpv_config_files + [job_conf_template]:
            if t.endswith('.yml'):
                test_fname = os.path.join(files_dir, os.path.basename(t))
                shutil.copy(t, test_fname)
                tpv_files.append(test_fname)

            elif t.endswith('.yml.j2'):
                test_fname = os.path.join(templates_dir, os.path.basename(t))
                shutil.copy(t, test_fname)
                sanitize_text(test_fname)
                templated_file = template_file(test_fname)
                if t != job_conf_template:
                    tpv_files.append(templated_file)

        # ------------------------------------------------------------------
        # Run TPV lint
        # ------------------------------------------------------------------

        report_lines = []
        lint_failed = False

        report_lines.append("# TPV lint report\n")

        result = subprocess.run(
            ["tpv", "lint"] + tpv_files,
            capture_output=True,
            text=True,
        )

        # ---- PRINT EVERYTHING TO THE CHECKS LOG ----

        if result.returncode != 0:
            lint_failed = True
            print("\n❌ **TPV lint failed**\n")
        else:
            print("\n✅ **TPV lint passed**\n")

        if result.stdout:
            print('STDOUT:')
            print(result.stdout, flush=True)

        if result.stderr:
            print('STDERR:')
            print(result.stderr, flush=True)

        # ---- FAIL AFTER ALL OUTPUT IS VISIBLE ----
        if lint_failed:
            raise RuntimeError("tpv lint failed")
