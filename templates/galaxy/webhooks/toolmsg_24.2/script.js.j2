// Custom messages for tool forms

let enableDebug = true;
const debugLog = (msg) => enableDebug && console.debug("[ToolMsg]: " + msg);

const WAIT_TOOL_MAX_TRIES = 3;
const WAIT_TOOL_MAX_SECONDS = 10;
const WAIT_TOOL_INTERVAL_MS = 500;
const toolMessages = [
    {% for message in toolmsg_messages %}
    {
        tool_id: "{{ message.tool_id }}",
        message: `{{ message.message }}`,
        class: "{{ message.class }}",
    },
    {% endfor %}
];
let tries = 0;
let lastUrlPath = null;

function waitToolFormLoad() {
    tries++;
    const element = document.getElementById('tool-card-body');
    if (element) {
        debugLog('Tool form has been loaded');
        showToolMessages();
    } else {
        debugLog("No tool form detected (tries: " + tries + ")");
        tries < (
            WAIT_TOOL_MAX_SECONDS * 1000
            / WAIT_TOOL_INTERVAL_MS
         ) && setTimeout(
            waitToolFormLoad,
            WAIT_TOOL_INTERVAL_MS,
        );
    }
}

function isCurrentToolForm(toolId) {
    const elements = document.querySelectorAll('[tool_id]');
    for (let element of elements) {
        const thisToolId = element.getAttribute('tool_id');
        if (thisToolId && thisToolId.startsWith(toolId)) {
            debugLog(toolId + " matches " + thisToolId);
            return true;
        }
    }
    debugLog(toolId + " not found in page.");
    return false;
}

function showToolMessages() {
    let match = false;
    toolMessages.forEach( (toolMessage, i) => {
        if (isCurrentToolForm(toolMessage.tool_id)) {
            const msgId = `toolmsg-${i}`
            const msgElement = document.createElement('p');
            msgElement.id = msgId;
            msgElement.className = 'alert alert-' + toolMessage.class + ' my-3';
            msgElement.innerHTML = toolMessage.message;
            let refElement = document.getElementById('tool-card-body');
            insertToolMsgElement(msgId, msgElement, refElement)
            match = true;
        }
    })
    return match;
}

// Ensure the reference element is really available - it seems to appear and
// disappear on more complex tool form renders
function insertToolMsgElement(msgId, msgElement, refElement) {
    if (!refElement) {
        debugLog('Waiting for reference element with id="tool-card-body"...');
        setTimeout(
            () => insertToolMsgElement(msgId, msgElement, refElement),
            WAIT_TOOL_INTERVAL_MS);
        return;
    }
    // Only insert if the message is not already present
    document.getElementById(msgId)
    || refElement.parentNode.insertBefore(msgElement, refElement);
}

// Add observer for Vue pathname changes
const observer = new MutationObserver( () => {
    if (lastUrlPath !== window.location.href) {
        debugLog("Triggered mutation observer");
        tries = 0;
        lastUrlPath = window.location.href;
        setTimeout(waitToolFormLoad, WAIT_TOOL_INTERVAL_MS);
    }
});

// Observe the document body for changes (or another relevant element)
observer.observe(document.body, { childList: true, subtree: true });
