- hosts: all
  become true

  pre_tasks:
      # the following is a workaround for dj-wasabi.telegraf role breaking on new VMs
      # the issue is that the dj-wasabi.telegraf role is not dearmoring the downloaded key
      # the dearmored key location is then passed to dj-wasabi.telegraf via a variable
      - name: Ensure /etc/apt/keyrings exists
        ansible.builtin.file:
          path: /etc/apt/keyrings
          state: directory
          mode: "0755"
        become: true

      - name: Fetch InfluxData key (ascii)
        ansible.builtin.get_url:
          url: https://repos.influxdata.com/influxdata-archive.key
          dest: /etc/apt/keyrings/influxdata-archive.asc
          mode: "0644"
        register: influx_key
        until: influx_key is succeeded
        retries: 3
        delay: 2
        become: true

      - name: Dearmor into a binary keyring if key has changed
        ansible.builtin.command: >
          gpg --batch --yes --dearmor
          -o /etc/apt/keyrings/influxdata-archive.gpg
          /etc/apt/keyrings/influxdata-archive.asc
        when: influx_key.changed
        become: true

      - name: Ensure permissions on keyring
        ansible.builtin.file:
          path: /etc/apt/keyrings/influxdata-archive.gpg
          owner: root
          group: root
          mode: "0644"
        become: true

  roles:
      - role: dj-wasabi.telegraf
        vars:
          # override the roleâ€™s internal set_fact when create telegraf.list
          telegraf_repository_params: "[signed-by=/etc/apt/keyrings/influxdata-archive.gpg]"

